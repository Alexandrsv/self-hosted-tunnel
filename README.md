# Self Hosted Tunnel

–≠—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –≥–æ—Ç–æ–≤–æ–µ —Ä–µ—à–µ–Ω–∏–µ –¥–ª—è –ø–æ–¥–Ω—è—Ç–∏—è —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ SSH-—Ç—É–Ω–Ω–µ–ª—è, –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ–≥–æ ngrok, –Ω–æ –Ω–∞ –≤–∞—à–µ–º —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ. –≠—Ç–æ –æ—Å–æ–±–µ–Ω–Ω–æ –ø–æ–ª–µ–∑–Ω–æ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ VK Mini Apps, –≤–µ–±—Ö—É–∫–æ–≤ –∏ –¥—Ä—É–≥–∏—Ö –∑–∞–¥–∞—á, –≥–¥–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø—É–±–ª–∏—á–Ω—ã–π HTTPS URL –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞.

–ü—Ä–æ–µ–∫—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **Docker**, **Nginx**, **OpenSSH** –∏ **Traefik** –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è SSL-—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ –∏ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏.

## üöÄ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- **–°—Ç–∞–±–∏–ª—å–Ω—ã–π –¥–æ–º–µ–Ω**: –í –æ—Ç–ª–∏—á–∏–µ –æ—Ç –Ω–µ–≤–µ—Ä–Ω–æ–≥–æ ngrok, –≤–∞—à –¥–æ–º–µ–Ω –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ.
- **SSL/TLS**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã Let's Encrypt —á–µ—Ä–µ–∑ Traefik.
- **–ò–∑–æ–ª—è—Ü–∏—è**: –†–∞–±–æ—Ç–∞–µ—Ç –≤ Docker-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ.
- **–ú–Ω–æ–≥–æ–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Ä–µ–∂–∏–º**: –ú–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π/–ø–æ—Ä—Ç–æ–≤ (—Ç—Ä–µ–±—É–µ—Ç –¥–æ—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–Ω—Ñ–∏–≥–∞).

## üõ† –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

1.  **Traefik**: –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –≤—Ö–æ–¥—è—â–∏–µ HTTPS –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –¥–æ–º–µ–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä, `tunnel.example.com`) –∏ –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç –∏—Ö –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä `nginx`.
2.  **Nginx**: –°–ª—É—à–∞–µ—Ç 80 –ø–æ—Ä—Ç –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –∏ –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ä—Ç (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `11211`), –∫—É–¥–∞ "–ø—Ä–∏–∑–µ–º–ª—è–µ—Ç—Å—è" SSH —Ç—É–Ω–Ω–µ–ª—å.
3.  **OpenSSH Server**: –ó–∞–ø—É—â–µ–Ω –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞, –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –≤—Ö–æ–¥—è—â–∏–µ SSH —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Ñ–ª–∞–≥–æ–º `-R` (Remote Port Forwarding).

## ‚öôÔ∏è –£—Å—Ç–∞–Ω–æ–≤–∫–∞ (–Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ)

### –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

- –°–µ—Ä–≤–µ—Ä —Å Linux (Ubuntu/Debian/CentOS).
- –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π [Docker](https://docs.docker.com/get-docker/) –∏ [Docker Compose](https://docs.docker.com/compose/install/).
- –ù–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –∏ —Ä–∞–±–æ—Ç–∞—é—â–∏–π **Traefik** –≤ —Å–µ—Ç–∏ `traefik-default` (–∏–ª–∏ –∏–∑–º–µ–Ω–∏—Ç–µ —Å–µ—Ç—å –≤ `docker-compose.yml`).
- –î–æ–º–µ–Ω–Ω–æ–µ –∏–º—è, –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–µ –Ω–∞ –≤–∞—à —Å–µ—Ä–≤–µ—Ä.

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞

1.  –ö–ª–æ–Ω–∏—Ä—É–π—Ç–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π:

    ```bash
    git clone https://github.com/Alexandrsv/self-hosted-tunnel.git
    cd self-hosted-tunnel
    ```

2.  –°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `.env` –∏–∑ –ø—Ä–∏–º–µ—Ä–∞:

    ```bash
    cp .env.example .env
    ```

3.  –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ `.env`:

    ```ini
    # –í–Ω–µ—à–Ω–∏–π –ø–æ—Ä—Ç –¥–ª—è HTTP (–æ–±—ã—á–Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –µ—Å–ª–∏ –µ—Å—Ç—å Traefik, –Ω–æ –Ω—É–∂–µ–Ω –¥–ª—è –º–∞–ø–ø–∏–Ω–≥–∞)
    EXTERNAL_HTTP_PORT=8080
    # –í–Ω–µ—à–Ω–∏–π –ø–æ—Ä—Ç –¥–ª—è SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è (—á–µ—Ä–µ–∑ –Ω–µ–≥–æ –±—É–¥–µ–º –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞—Ç—å —Ç—É–Ω–Ω–µ–ª—å)
    EXTERNAL_SSH_PORT=2222

    # –ò–º—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–ø—Ä–µ—Ñ–∏–∫—Å –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –∏ —Ä–æ—É—Ç–µ—Ä–æ–≤)
    APP_NAME=tunnel11211

    # –í–∞—à –¥–æ–º–µ–Ω –¥–ª—è —Ç—É–Ω–Ω–µ–ª—è
    DOMAIN=tunnel.example.com

    # –ü—É–±–ª–∏—á–Ω—ã–π SSH –∫–ª—é—á –∫–ª–∏–µ–Ω—Ç–∞ (–≤–∞—à–µ–≥–æ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∫–æ–º–ø—å—é—Ç–µ—Ä–∞)
    # –í—ã–ø–æ–ª–Ω–∏—Ç–µ `cat ~/.ssh/id_rsa.pub` –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω–µ –∏ –≤—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞
    SSH_AUTHORIZED_KEY=ssh-rsa AAAAB3NzaC1yc2E...
    ```

### –ó–∞–ø—É—Å–∫

–ó–∞–ø—É—Å—Ç–∏—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä:

```bash
docker compose up -d --build
```

## üíª –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ (–Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω–µ)

–î–ª—è –ø—Ä–æ–±—Ä–æ—Å–∞ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –ø–æ—Ä—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 3000) –Ω–∞ —Å–µ—Ä–≤–µ—Ä, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É SSH.

### –ö–æ–º–∞–Ω–¥–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

```bash
ssh -p <EXTERNAL_SSH_PORT> \
    -o "UserKnownHostsFile=/dev/null" \
    -o "StrictHostKeyChecking no" \
    -N -R "*:11211:localhost:3000" \
    publisher@<YOUR_SERVER_IP_OR_DOMAIN>
```

- `-p <EXTERNAL_SSH_PORT>`: –ü–æ—Ä—Ç, —É–∫–∞–∑–∞–Ω–Ω—ã–π –≤ `.env` –∫–∞–∫ `EXTERNAL_SSH_PORT` (–Ω–∞–ø—Ä–∏–º–µ—Ä, 2222).
- `-N`: –ù–µ –≤—ã–ø–æ–ª–Ω—è—Ç—å —É–¥–∞–ª–µ–Ω–Ω—É—é –∫–æ–º–∞–Ω–¥—É (—Ç–æ–ª—å–∫–æ –ø—Ä–æ–±—Ä–æ—Å –ø–æ—Ä—Ç–æ–≤).
- `-R "*:11211:localhost:3000"`: –ü—Ä–æ–±—Ä–æ—Å–∏—Ç—å —É–¥–∞–ª–µ–Ω–Ω—ã–π –ø–æ—Ä—Ç `11211` (–≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞) –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—ã–π `3000`. **–í–∞–∂–Ω–æ:** –ø–æ—Ä—Ç `11211` –∂–µ—Å—Ç–∫–æ –ø—Ä–æ–ø–∏—Å–∞–Ω –≤ `nginx.conf`, –µ—Å–ª–∏ –º–µ–Ω—è–µ—Ç–µ –µ–≥–æ, –º–µ–Ω—è–π—Ç–µ –∏ —Ç–∞–º.
- `publisher`: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, —Å–æ–∑–¥–∞–≤–∞–µ–º—ã–π –≤ Dockerfile.

### –£–¥–æ–±–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ package.json

–î–æ–±–∞–≤—å—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ —Å–∫—Ä–∏–ø—Ç—ã –≤ –≤–∞—à `package.json` –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –∑–∞–ø—É—Å–∫–∞:

```json
{
  "scripts": {
    "tunnel": "ssh -p 2222 -o \"UserKnownHostsFile=/dev/null\" -o \"StrictHostKeyChecking no\" -N -R \"*:11211:localhost:3000\" publisher@tunnel.example.com",
    "tunnel:restart": "ssh root@example.com 'docker compose -f /root/containers/tunnel11211/docker-compose.yml down; docker compose -f /root/containers/tunnel11211/docker-compose.yml up -d'"
  }
}
```

- –ó–∞–º–µ–Ω–∏—Ç–µ `2222` –Ω–∞ –≤–∞—à `EXTERNAL_SSH_PORT`.
- –ó–∞–º–µ–Ω–∏—Ç–µ `tunnel.example.com` –Ω–∞ –≤–∞—à –¥–æ–º–µ–Ω –∏–ª–∏ IP.
- –ó–∞–º–µ–Ω–∏—Ç–µ `root@example.com` –∏ –ø—É—Ç–∏ –≤ `tunnel:restart` –Ω–∞ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–ª—è –≤–∞—à–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞.

–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –∑–∞–ø—É—Å–∫–∞—Ç—å —Ç—É–Ω–Ω–µ–ª—å –∫–æ–º–∞–Ω–¥–æ–π:

```bash
npm run tunnel
```

### –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

–ï—Å–ª–∏ SSH —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–∞–∑–æ—Ä–≤–∞–ª–æ—Å—å –∏ –Ω–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è (–ø–æ—Ä—Ç –∑–∞–Ω—è—Ç –∏–ª–∏ –∑–∞–≤–∏—Å), –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É —Ä–µ—Å—Ç–∞—Ä—Ç–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:

```bash
npm run tunnel:restart
```

–≠—Ç–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ, —Å–±—Ä–æ—Å–∏–≤ –≤—Å–µ –∑–∞–≤–∏—Å—à–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è.

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

- `Dockerfile`: –°–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–∞ –Ω–∞ –±–∞–∑–µ Nginx —Å —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π OpenSSH –∏ Supervisor.
- `docker-compose.yml`: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–∞ –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Traefik.
- `nginx.conf`: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Nginx –¥–ª—è –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ —Å 80 –ø–æ—Ä—Ç–∞ –Ω–∞ 11211.
- `entrypoint.sh`: –°–∫—Ä–∏–ø—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ (–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–µ–π —Ö–æ—Å—Ç–∞, –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤).
- `supervisord.conf`: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞–º–∏ Nginx –∏ SSHD.
